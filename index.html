<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>B/RIDGE Readiness Gauge</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background:#fff; }
    .wrap { max-width: 920px; margin: 0 auto; }
    .card { border: 1px solid #e5e5e5; border-radius: 14px; padding: 18px; }
    .title { font-weight: 800; margin: 0 0 6px; font-size: 22px; }
    .sub { color:#666; margin: 0 0 14px; }
    .row { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .pill { padding:7px 12px; border-radius: 999px; background:#f3f3f3; font-size: 13px; }
    .legend { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .lg { display:flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px; background:#f6f6f6; font-size:13px; }
    .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
    #gauge { width: 100%; height: 420px; display:block; }
  </style>
</head>

<body>
  <div class="wrap card">
    <div class="title">B/RIDGE™ Workforce Readiness</div>
    <div class="sub" id="subText">Showing latest result for your email</div>

    <div class="row">
      <span class="pill" id="scorePill">Score: -</span>
      <span class="pill" id="labelPill">Label: -</span>
    </div>

    <canvas id="gauge"></canvas>

<div id="plan" style="margin-top:16px; padding:14px; border:1px solid #eee; border-radius:12px;"></div>
    
    <div class="legend">
      <div class="lg"><span class="dot" style="background:#2ecc71"></span>High: 80–100</div>
      <div class="lg"><span class="dot" style="background:#f1c40f"></span>Moderate: 60–79</div>
      <div class="lg"><span class="dot" style="background:#f39c12"></span>Low: 40–59</div>
      <div class="lg"><span class="dot" style="background:#e74c3c"></span>Critical: 0–39</div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzFGo8yjKkfXQ5nYEqGDwo_CLN0LwLelOJSZFTMH0nZLLREQ9IomXRhsj2daLr0hbLTfw/exec";

  const LABEL_COLORS = {
    High: "#2ecc71",
    Moderate: "#f1c40f",
    Low: "#f39c12",
    Critical: "#e74c3c",
  };

  let currentScore = null;
  let currentLabel = null;

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function scoreToLabel(score){
    if (score >= 80) return "High";
    if (score >= 60) return "Moderate";
    if (score >= 40) return "Low";
    return "Critical";
  }
  function scoreToAngle(score){
    const s = clamp(score,0,100);
    return (2 - (s/100)) * Math.PI;
  }
  function getParam(name){
    const u = new URL(window.location.href);
    const v = u.searchParams.get(name);
    return v ? v.trim() : "";
  }
  function roundedRect(ctx, x, y, w, h, r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }
  function labelColor(label){
    return LABEL_COLORS[label] || "#e74c3c";
  }
  function resizeCanvas(canvas){
    const dpr = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth;
    const cssH = canvas.clientHeight;
    canvas.width  = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  function polar(cx, cy, r, ang){
    return { x: cx + Math.cos(ang) * r, y: cy + Math.sin(ang) * r };
  }

  function drawGauge(score, label){
    const canvas = document.getElementById("gauge");
    resizeCanvas(canvas);
    const ctx = canvas.getContext("2d");

    const W = canvas.clientWidth;
    const H = canvas.clientHeight;
    ctx.clearRect(0,0,W,H);

    const cx = W/2;
    const cy = H*0.88;
    const rOuter = Math.min(W*0.43, H*0.80);
    const thickness = Math.max(26, rOuter*0.18);
    const rMid = rOuter - thickness/2;
    const rInner = rOuter - thickness - 10;

    // background arc
    ctx.lineCap = "butt";
    ctx.lineWidth = thickness;
    ctx.strokeStyle = "#e9ecef";
    ctx.beginPath();
    ctx.arc(cx, cy, rMid, Math.PI, 0, false);
    ctx.stroke();

    // segments
    const segments = [
      { from: 0,  to: 39,  color: "#e74c3c" },
      { from: 40, to: 59,  color: "#f39c12" },
      { from: 60, to: 79,  color: "#f1c40f" },
      { from: 80, to: 100, color: "#2ecc71" },
    ];

    segments.forEach(seg => {
      const a1 = scoreToAngle(seg.from);
      const a2 = scoreToAngle(seg.to);
      ctx.strokeStyle = seg.color;
      ctx.beginPath();
      ctx.arc(cx, cy, rMid, a1, a2, true);
      ctx.stroke();
    });

    // inner face
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(cx, cy, rInner, Math.PI, 0, false);
    ctx.lineTo(cx, cy);
    ctx.closePath();
    ctx.fill();

    // outline
    ctx.strokeStyle = "#cfd4da";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(cx, cy, rOuter+1, Math.PI, 0, false);
    ctx.stroke();

    // needle
    const ang = scoreToAngle(score);
    const needleLen = rInner * 0.98;

    const tip = polar(cx, cy, needleLen, ang);
    const back = polar(cx, cy, 16, ang + Math.PI);

    const perp = ang + Math.PI/2;
    const left = polar(cx, cy, 6, perp);
    const right = polar(cx, cy, 6, perp + Math.PI);

    ctx.fillStyle = "#2c3e50";
    ctx.beginPath();
    ctx.moveTo(tip.x, tip.y);
    ctx.lineTo(left.x, left.y);
    ctx.lineTo(back.x, back.y);
    ctx.lineTo(right.x, right.y);
    ctx.closePath();
    ctx.fill();

    // hub
    ctx.beginPath();
    ctx.arc(cx, cy, 12, 0, Math.PI*2);
    ctx.fill();

    // center text
    ctx.textAlign = "center";
    ctx.fillStyle = "#111";
    ctx.font = "800 64px Arial";
    ctx.fillText(`${Math.round(score)}%`, cx, H*0.52);

    // label pill
    const lbl = label || scoreToLabel(score);
    const pillW = 240, pillH = 44;
    const pillX = cx - pillW/2;
    const pillY = H*0.56;
    ctx.fillStyle = labelColor(lbl);
    roundedRect(ctx, pillX, pillY, pillW, pillH, 22);
    ctx.fill();

    ctx.fillStyle = "#111";
    ctx.font = "700 20px Arial";
    ctx.fillText(`${lbl} Readiness`, cx, pillY + 30);
  }

  function renderActionPlan(label){
    const plans = {
      High: [
        "Maintain routines: weekly check-in + monthly review.",
        "Share best practices with your team (peer mentoring).",
        "Set 1 stretch-goal for next quarter."
      ],
      Moderate: [
        "Pick 2 capability gaps to improve in 30 days.",
        "Do 1 training session + 1 practice task per week.",
        "Ask manager for feedback on 1 real work scenario."
      ],
      Low: [
        "Focus on fundamentals: define role expectations + SOP.",
        "Schedule coaching/mentoring weekly for 4 weeks.",
        "Create a simple 2-week improvement plan with milestones."
      ],
      Critical: [
        "Immediate support: clarify responsibilities + urgent training.",
        "Assign buddy/mentor and daily check-ins for 1 week.",
        "Stabilize workload + remove blockers before scaling tasks."
      ]
    };

    const el = document.getElementById("plan");
    if (!el) return;

    const list = (plans[label] || plans.Low).map(x => `<li>${x}</li>`).join("");
    el.innerHTML = `
      <div style="font-weight:800; margin-bottom:8px;">Recommended Action Plan</div>
      <ul style="margin:0; padding-left:18px;">${list}</ul>
    `;
  }

  function init(){
    const token = getParam("t");
    if (!token){
      document.getElementById("subText").textContent = "Missing parameter: ?t=";
      document.getElementById("labelPill").textContent = "No token provided";
      return;
    }

    const cbName = "cb_" + Math.random().toString(36).slice(2);

    window[cbName] = (resp) => {
      try{
        if (!resp || !resp.ok){
          document.getElementById("subText").textContent = (resp && resp.error) ? resp.error : "No data";
          document.getElementById("labelPill").textContent = "No data";
          return;
        }

        const score = clamp(Number(resp.total), 0, 100);
        const label = (resp.label || scoreToLabel(score)).trim() || scoreToLabel(score);

        currentScore = score;
        currentLabel = label;

        document.getElementById("subText").textContent =
          resp.ts ? `Latest submission: ${resp.ts}` : "Showing latest result";

        document.getElementById("scorePill").textContent = `Score: ${score.toFixed(1)}`;

        const lp = document.getElementById("labelPill");
        lp.textContent = `Label: ${label}`;
        lp.style.background = LABEL_COLORS[label] || "#f3f3f3";
        lp.style.color = (label === "Moderate") ? "#111" : "#fff";
        lp.style.fontWeight = "700";

        drawGauge(score, label);
        renderActionPlan(label);
      } finally {
        delete window[cbName];
      }
    };

    const s = document.createElement("script");
    s.src = `${API_URL}?t=${encodeURIComponent(token)}&callback=${encodeURIComponent(cbName)}`;
    s.onerror = () => {
      document.getElementById("subText").textContent = "Failed to load data (API error / permissions).";
    };
    document.head.appendChild(s);
  }

  window.addEventListener("resize", () => {
    if (currentScore !== null) drawGauge(currentScore, currentLabel);
  });

  init();
</script>

</body>
</html>

