<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>B/RIDGE Readiness Gauge</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background:#fff; }
    .wrap { max-width: 920px; margin: 0 auto; }
    .card { border: 1px solid #e5e5e5; border-radius: 14px; padding: 18px; }
    .title { font-weight: 800; margin: 0 0 6px; font-size: 22px; }
    .sub { color:#666; margin: 0 0 14px; }
    .row { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .pill { padding:7px 12px; border-radius: 999px; background:#f3f3f3; font-size: 13px; }
    .legend { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .lg { display:flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px; background:#f6f6f6; font-size:13px; }
    .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
    #gauge { width: 100%; height: 420px; display:block; }
  </style>
</head>
<body>
  <div class="wrap card">
    <div class="title">B/RIDGE™ Workforce Readiness</div>
    <div class="sub" id="subText">Showing latest result for your email</div>

    <div class="row">
      <span class="pill" id="emailPill">Email: -</span>
      <span class="pill" id="scorePill">Score: -</span>
      <span class="pill" id="labelPill">Label: -</span>
      <span class="pill" id="tsPill" style="display:none;">Timestamp: -</span>
    </div>

    <canvas id="gauge"></canvas>

    <div class="legend">
      <div class="lg"><span class="dot" style="background:#2ecc71"></span>High: 80–100</div>
      <div class="lg"><span class="dot" style="background:#f1c40f"></span>Moderate: 60–79</div>
      <div class="lg"><span class="dot" style="background:#f39c12"></span>Low: 40–59</div>
      <div class="lg"><span class="dot" style="background:#e74c3c"></span>Critical: 0–39</div>
    </div>
  </div>

<script>
  // CSV dari tab Latest_By_Email
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSTtdTF28afrK__RsR6-8PVcDWvn-si4vjUPrW6WGg69-qPWsobQYIPA18a4ZBSuzxZnVWMYkCKSMJV/pub?gid=2042210280&single=true&output=csv";

  const labelColors = {
    High: "#2ecc71",
    Moderate: "#f1c40f",
    Low: "#f39c12",
    Critical: "#e74c3c",
  };

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function scoreToLabel(score){
    if (score >= 80) return "High";
    if (score >= 60) return "Moderate";
    if (score >= 40) return "Low";
    return "Critical";
  }

  function getParam(name){
    const u = new URL(window.location.href);
    const v = u.searchParams.get(name);
    return v ? v.trim() : "";
  }

  // Score 0 -> right end, Score 100 -> left end
  // Use angles from 2π (right) to π (left) so semicircle is on TOP.
  function scoreToAngle(score){
    const s = clamp(score,0,100);
    return (2 - (s/100)) * Math.PI; // 0=>2π, 100=>π
  }

  // CSV parser aman
  function parseCSV(text){
    const rows = [];
    let row = [], cur = "", inQ = false;
    for (let i=0; i<text.length; i++){
      const c = text[i], n = text[i+1];
      if (c === '"'){
        if (inQ && n === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if (c === ',' && !inQ){
        row.push(cur); cur = "";
      } else if ((c === '\n' || c === '\r') && !inQ){
        if (c === '\r' && n === '\n') i++;
        row.push(cur);
        rows.push(row.map(x => x.replace(/^"|"$/g,"").trim()));
        row = []; cur = "";
      } else {
        cur += c;
      }
    }
    if (cur.length || row.length){
      row.push(cur);
      rows.push(row.map(x => x.replace(/^"|"$/g,"").trim()));
    }
    return rows.filter(r => r.some(x => x !== ""));
  }

  function roundedRect(ctx, x, y, w, h, r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }

  function resizeCanvas(canvas){
    const dpr = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth;
    const cssH = canvas.clientHeight;
    canvas.width  = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function drawGauge(score, label){
    const canvas = document.getElementById("gauge");
    resizeCanvas(canvas);
    const ctx = canvas.getContext("2d");

    const W = canvas.clientWidth;
    const H = canvas.clientHeight;
    ctx.clearRect(0,0,W,H);

    const cx = W/2;
    const cy = H*0.88;
    const rOuter = Math.min(W*0.43, H*0.80);
    const thickness = Math.max(26, rOuter*0.18);
    const rMid = rOuter - thickness/2;
    const rInner = rOuter - thickness - 10;

    // background arc TOP (important: anticlockwise=true)
    ctx.lineCap = "butt";
    ctx.lineWidth = thickness;
    ctx.strokeStyle = "#e9ecef";
    ctx.beginPath();
    ctx.arc(cx, cy, rMid, 2*Math.PI, Math.PI, true);
    ctx.stroke();

    // 4 segments
    const segments = [
      { from: 0,  to: 39,  color: "#e74c3c" },
      { from: 40, to: 59,  color: "#f39c12" },
      { from: 60, to: 79,  color: "#f1c40f" },
      { from: 80, to: 100, color: "#2ecc71" },
    ];

    segments.forEach(seg => {
      const a1 = scoreToAngle(seg.from);
      const a2 = scoreToAngle(seg.to);
      ctx.strokeStyle = seg.color;
      ctx.beginPath();
      ctx.arc(cx, cy, rMid, a1, a2, true); // TOP, anticlockwise=true
      ctx.stroke();
    });

    // inner white face TOP
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(cx, cy, rInner, 2*Math.PI, Math.PI, true);
    ctx.lineTo(cx, cy);
    ctx.closePath();
    ctx.fill();

    // outline TOP
    ctx.strokeStyle = "#cfd4da";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(cx, cy, rOuter+1, 2*Math.PI, Math.PI, true);
    ctx.stroke();

    // needle
    const ang = scoreToAngle(score);
    const needleLen = rInner * 0.98;

    const tipX = cx + Math.cos(ang) * needleLen;
    const tipY = cy + Math.sin(ang) * needleLen;

    const baseLen = 16;
    const perp = ang + Math.PI/2;

    const leftX  = cx + Math.cos(perp) * 6;
    const leftY  = cy + Math.sin(perp) * 6;
    const rightX = cx - Math.cos(perp) * 6;
    const rightY = cy - Math.sin(perp) * 6;

    const backX = cx - Math.cos(ang) * baseLen;
    const backY = cy - Math.sin(ang) * baseLen;

    ctx.fillStyle = "#2c3e50";
    ctx.beginPath();
    ctx.moveTo(tipX, tipY);
    ctx.lineTo(leftX, leftY);
    ctx.lineTo(backX, backY);
    ctx.lineTo(rightX, rightY);
    ctx.closePath();
    ctx.fill();

    // hub
    ctx.beginPath();
    ctx.arc(cx, cy, 12, 0, Math.PI*2);
    ctx.fill();

    // big %
    ctx.textAlign = "center";
    ctx.fillStyle = "#111";
    ctx.font = "800 64px Arial";
    ctx.fillText(`${Math.round(score)}%`, cx, H*0.52);

    // label pill in gauge
    const lbl = label || scoreToLabel(score);
    const pillW = 240, pillH = 44;
    const pillX = cx - pillW/2;
    const pillY = H*0.56;

    ctx.fillStyle = labelColors[lbl] || "#999";
    roundedRect(ctx, pillX, pillY, pillW, pillH, 22);
    ctx.fill();

    ctx.fillStyle = "#111";
    ctx.font = "700 20px Arial";
    ctx.fillText(`${lbl} Readiness`, cx, pillY + 30);
  }

  async function fetchText(url){
    const res = await fetch(url, { cache: "no-store" });
    return await res.text();
  }

  async function init(){
    const emailParam = getParam("email").toLowerCase();
    document.getElementById("emailPill").textContent = `Email: ${emailParam || "-"}`;

    if (!emailParam){
      document.getElementById("labelPill").textContent = "Missing: ?email=";
      document.getElementById("scorePill").textContent = "Score: -";
      return;
    }

    const csvText = await fetchText(CSV_URL);
    const raw = parseCSV(csvText);

    const header = raw[0].map(h => h.toLowerCase());
    const idxEmail = header.indexOf("email");
    const idxTotal = header.indexOf("total");
    const idxLabel = header.indexOf("label");
    const idxTS = header.findIndex(h => h.includes("timestamp"));

    if (idxEmail < 0 || idxTotal < 0){
      document.getElementById("labelPill").textContent = "CSV missing Email/Total columns";
      return;
    }

    const rows = raw.slice(1).map(r => ({
      email: (r[idxEmail] || "").trim().toLowerCase(),
      total: Number(r[idxTotal]),
      label: (idxLabel >= 0 ? (r[idxLabel] || "").trim() : ""),
      ts: (idxTS >= 0 ? (r[idxTS] || "").trim() : "")
    })).filter(x => x.email && !Number.isNaN(x.total));

    const found = rows.find(x => x.email === emailParam);

    if (!found){
      document.getElementById("labelPill").textContent = "No data for this email";
      document.getElementById("scorePill").textContent = "Score: -";
      return;
    }

    const score = clamp(found.total, 0, 100);
    const label = found.label || scoreToLabel(score);

    document.getElementById("scorePill").textContent = `Score: ${score.toFixed(1)}`;

    const lp = document.getElementById("labelPill");
    lp.textContent = `Label: ${label}`;
    lp.style.background = labelColors[label] || "#f3f3f3";
    lp.style.color = (label === "Moderate") ? "#111" : "#fff";
    lp.style.fontWeight = "700";

    // Optional tampilkan timestamp terakhir
    if (found.ts){
      const tp = document.getElementById("tsPill");
      tp.style.display = "inline-block";
      tp.textContent = `Timestamp: ${found.ts}`;
    }

    drawGauge(score, label);
  }

  init();
</script>
</body>
</html>
